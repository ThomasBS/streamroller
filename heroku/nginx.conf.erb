# This is a lazy workaround to convert RTMPT streams to RTMP on Heroku

#user  nobody;
worker_processes  1;
daemon off;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
	use epoll;
	accept_mutex on;
	worker_connections 1024;
}

http {
	log_format l2met 'measure#nginx.service=$request_time request_id=$http_x_request_id';
	access_log logs/nginx/access.log l2met;
	error_log logs/nginx/error.log;

  upstream goserver {
    server 127.0.0.1:8080;
  }

  server {
    listen <%= ENV["PORT"] %>;

    location ~ (^/open/1$|^/idle/.*/.*$|^/send/.*/.*$|^/close/.*/.*$) {
      rtmpt_proxy on;
      rtmpt_proxy_target 127.0.0.1:8080;
      rtmpt_proxy_rtmp_timeout 20;
      rtmpt_proxy_http_timeout 20;

      add_header Cache-Control no-cache;
      access_log off;
    }
    location /fcs/ident2 {
      return 404;
    }
    location / {
      proxy_set_header Host $host;
      proxy_pass http://goserver;

      # WebSocket support
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }
  }
}
